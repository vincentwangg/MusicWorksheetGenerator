<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Apex Recoil Simulator</title>
</head>
<body>
<div>
    <p id="output"></p>
</div>
<script src="opensheetmusicdisplay.min.js"></script>

<script>
    let prettifyXml = function(sourceXml)
    {
        let xmlDoc = new DOMParser().parseFromString(sourceXml, 'application/xml');
        let xsltDoc = new DOMParser().parseFromString([
            // describes how we want to modify the XML - indent everything
            '<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">',
            '  <xsl:strip-space elements="*"/>',
            '  <xsl:template match="para[content-style][not(text())]">', // change to just text() to strip space in text nodes
            '    <xsl:value-of select="normalize-space(.)"/>',
            '  </xsl:template>',
            '  <xsl:template match="node()|@*">',
            '    <xsl:copy><xsl:apply-templates select="node()|@*"/></xsl:copy>',
            '  </xsl:template>',
            '  <xsl:output indent="yes"/>',
            '</xsl:stylesheet>',
        ].join("\n"), 'application/xml');

        let xsltProcessor = new XSLTProcessor();
        xsltProcessor.importStylesheet(xsltDoc);
        let resultDoc = xsltProcessor.transformToDocument(xmlDoc);
        return new XMLSerializer().serializeToString(resultDoc);
    };
</script>
<script>
    // Random copied stuff
    function copyTextToClipboard(text) {
        var textArea = document.createElement("textarea");

        // Place in the top-left corner of screen regardless of scroll position.
        textArea.style.position = 'fixed';
        textArea.style.top = 0;
        textArea.style.left = 0;

        // Ensure it has a small width and height. Setting to 1px / 1em
        // doesn't work as this gives a negative w/h on some browsers.
        textArea.style.width = '2em';
        textArea.style.height = '2em';

        // We don't need padding, reducing the size if it does flash render.
        textArea.style.padding = 0;

        // Clean up any borders.
        textArea.style.border = 'none';
        textArea.style.outline = 'none';
        textArea.style.boxShadow = 'none';

        // Avoid flash of the white box if rendered for any reason.
        textArea.style.background = 'transparent';


        textArea.value = text;

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            var successful = document.execCommand('copy');
            var msg = successful ? 'successful' : 'unsuccessful';
        } catch (err) {
            document.getElementById("debugOutput").innerText = "Error happened when copying to clipboard. Here's the text to manually copy for yourself: " + text;
        }

        document.body.removeChild(textArea);
    }
</script>
<button onclick="copyXML()">Copy XML to clipboard</button>
<script>
    let pianoNoteRange = ["A0", "B0", "C1", "D1", "E1", "F1", "G1", "A1", "B1", "C2", "D2", "E2", "F2", "G2", "A2", "B2", "C3", "D3", "E3", "F3", "G3", "A3", "B3", "C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5", "D5", "E5", "F5", "G5", "A5", "B5", "C6", "D6", "E6", "F6", "G6", "A6", "B6", "C7", "D7", "E7", "F7", "G7", "A7", "B7", "C8"];

    let baseMusicXML = new DOMParser().parseFromString("<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?><!DOCTYPE score-partwise PUBLIC \"-//Recordare//DTD MusicXML 3.1 Partwise//EN\" \"http://www.musicxml.org/dtds/partwise.dtd\"><score-partwise version=\"3.1\"><part-list><score-part id=\"P1\"><part-name>Music</part-name></score-part></part-list><part id=\"P1\"></part></score-partwise>", "application/xml");

    for (let i = 0; i < 20; i++) {
        let measure = createMeasure();

        if (i === 0) {
            let divisions = createElement("divisions");
            let attributes = baseMusicXML.createElement("attributes");
            divisions.innerHTML = "2";
            attributes.appendChild(createTimeSignature());
            attributes.appendChild(createClef("bass"));
            measure.appendChild(divisions);
            measure.appendChild(attributes);
        }
        for (let j = 0; j < 4; j++) {
            measure.appendChild(createRandomNoteWithinRangeInclusive("D2", "C4")); // easy mode bass clef
            // measure.appendChild(createRandomNoteWithinRangeInclusive("B1", "F4")); // hard mode bass clef
        }
        baseMusicXML.getElementsByTagName("part")[0].appendChild(measure);
    }

    document.getElementById("output").innerText = new XMLSerializer().serializeToString(baseMusicXML);

    function createElement(elementName) {
        return baseMusicXML.createElement(elementName);
    }

    function createMeasure() {
        let measureElement = createElement("measure");
        return measureElement;
    }

    function createClef(clefMode = "treble") {
        let clef = createElement("clef");
        let sign = createElement("sign");
        sign.innerHTML = clefMode === "treble" ? "G" : "F";
        let line = createElement("line");
        line.innerHTML = clefMode === "treble" ? "2" : "4";
        clef.appendChild(sign);
        clef.appendChild(line);
        return clef;
    }

    function createTimeSignature() {
        let time = createElement("time");
        let beats = createElement("beats");
        let beatType = createElement("beat-type");

        time.appendChild(beats);
        time.appendChild(beatType);

        beats.innerHTML = "4";
        beatType.innerHTML = "4";

        return time;
    }

    /**
     * @param step If doing F4, step is F
     * @param octave If doing F4, octave is 4
     */
    function createNote(noteType = "quarter", step, octave) {
        let note = createElement("note");
        let pitch = createElement("pitch");
        let stepElement = createElement("step");
        let octaveElement = createElement("octave");
        let durationElement = createElement("duration");
        let type = createElement("type");

        stepElement.innerHTML = step;
        octaveElement.innerHTML = octave;
        durationElement.innerHTML = "2"; // todo change later to be dynamic
        type.innerHTML = noteType;

        pitch.appendChild(stepElement);
        pitch.appendChild(octaveElement);
        note.appendChild(pitch);
        note.appendChild(durationElement);
        note.appendChild(type);

        return note;
    }

    function createRandomNoteWithinRangeInclusive(lowerLimit, higherLimit) {
        let lowerIdx = pianoNoteRange.indexOf(lowerLimit);
        let higherIdx = pianoNoteRange.indexOf(higherLimit);

        let note = pianoNoteRange[getRandomIntInclusive(lowerIdx, higherIdx)];
        return createNote("quarter", note.charAt(0), note.charAt(1));
    }

    function getRandomIntInclusive(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1) + min); //The maximum is inclusive and the minimum is inclusive
    }

    function copyXML() {
        copyTextToClipboard(new XMLSerializer().serializeToString(baseMusicXML));
    }
</script>
</body>